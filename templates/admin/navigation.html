{% extends "base.html" %}

{% block title %}导航管理 - JuFire Studio{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- 页面标题和操作按钮 -->
    <div class="d-flex justify-content-between align-items-center py-4 border-bottom">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-compass text-primary me-2"></i>
                导航管理
            </h1>
            <p class="text-muted mb-0">管理网站导航分类和导航项</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                <i class="fas fa-folder-plus me-1"></i>
                新增分类
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNavItemModal">
                <i class="fas fa-plus me-1"></i>
                新增导航
            </button>
        </div>
    </div>

    <!-- 统计卡片 -->
    <div class="row g-3 my-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                总分类数
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ categories|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-folder fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                总导航数
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ nav_items|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-link fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                公开导航
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ nav_items|selectattr('is_public')|list|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-eye fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                私有导航
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ nav_items|rejectattr('is_public')|list|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-eye-slash fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 分类和导航项列表 -->
    {% if categories %}
    {% for category in categories %}
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="{{ category.icon }} text-primary me-2"></i>
                <h6 class="m-0 font-weight-bold text-primary">{{ category.name }}</h6>
                <span class="badge bg-primary ms-2">{{ category.nav_items|length }}</span>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary edit-category" 
                    data-category-id="{{ category.id }}"
                    data-category-name="{{ category.name }}"
                    data-category-icon="{{ category.icon }}"
                    data-category-order="{{ category.order }}">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger delete-category" 
                    data-category-id="{{ category.id }}"
                    data-category-name="{{ category.name }}">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addNavItemModal" 
                    data-category-id="{{ category.id }}">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            {% if category.nav_items %}
            <div class="table-responsive">
                <table class="table table-bordered" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>导航信息</th>
                            <th>URL</th>
                            <th>状态</th>
                            <th>排序</th>
                            <th>创建者</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in category.nav_items|sort(attribute='order') %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="{{ item.icon or 'fas fa-link' }} text-primary" style="font-size: 1.2rem;"></i>
                                    </div>
                                    <div>
                                        <div class="font-weight-bold">{{ item.title }}</div>
                                        {% if item.description %}
                                        <div class="text-muted small">{{ item.description[:50] }}{% if item.description|length > 50 %}...{% endif %}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <a href="{{ item.url }}" target="_blank" class="text-decoration-none">
                                    {{ item.url[:40] }}{% if item.url|length > 40 %}...{% endif %}
                                    <i class="fas fa-external-link-alt ms-1"></i>
                                </a>
                            </td>
                            <td>
                                {% if item.is_public %}
                                <span class="badge bg-success">公开</span>
                                {% else %}
                                <span class="badge bg-secondary">私有</span>
                                {% endif %}
                            </td>
                            <td>{{ item.order }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        <i class="fas fa-user-circle text-gray-400"></i>
                                    </div>
                                    <div class="font-weight-bold">{{ item.creator.username if item.creator else '未知' }}</div>
                                </div>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary edit-nav-item" 
                                        data-item-id="{{ item.id }}"
                                        data-item-title="{{ item.title }}"
                                        data-item-url="{{ item.url }}"
                                        data-item-description="{{ item.description or '' }}"
                                        data-item-icon="{{ item.icon or '' }}"
                                        data-item-category-id="{{ item.category_id }}"
                                        data-item-is-public="{{ item.is_public|lower }}"
                                        data-item-order="{{ item.order }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-nav-item" 
                                        data-item-id="{{ item.id }}"
                                        data-item-title="{{ item.title }}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary toggle-visibility" 
                                        data-item-id="{{ item.id }}"
                                        data-is-public="{{ item.is_public|lower }}">
                                        {% if item.is_public %}
                                        <i class="fas fa-eye-slash"></i>
                                        {% else %}
                                        <i class="fas fa-eye"></i>
                                        {% endif %}
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-3x text-gray-300 mb-3"></i>
                <p class="text-muted">该分类下暂无导航项</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNavItemModal" 
                    data-category-id="{{ category.id }}">
                    <i class="fas fa-plus me-1"></i>
                    添加第一个导航项
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="card shadow">
        <div class="card-body text-center py-5">
            <i class="fas fa-folder-open fa-3x text-gray-300 mb-3"></i>
            <h5 class="text-gray-600">暂无导航分类</h5>
            <p class="text-muted">请先创建一个导航分类</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                <i class="fas fa-folder-plus me-1"></i>
                创建第一个分类
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- 添加分类模态框 -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">
                    <i class="fas fa-folder-plus me-2"></i>
                    添加导航分类
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">分类名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                    <div class="mb-3">
                        <label for="categoryIcon" class="form-label">图标</label>
                        <input type="text" class="form-control" id="categoryIcon" value="fas fa-link" placeholder="例如: fas fa-link">
                        <div class="form-text">Font Awesome 图标类名</div>
                    </div>
                    <div class="mb-3">
                        <label for="categoryOrder" class="form-label">排序</label>
                        <input type="number" class="form-control" id="categoryOrder" value="0" min="0">
                        <div class="form-text">数字越小排序越靠前</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveCategoryBtn">
                    <i class="fas fa-save me-1"></i>
                    保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑分类模态框 -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCategoryModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    编辑导航分类
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCategoryForm">
                    <input type="hidden" id="editCategoryId">
                    <div class="mb-3">
                        <label for="editCategoryName" class="form-label">分类名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editCategoryName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCategoryIcon" class="form-label">图标</label>
                        <input type="text" class="form-control" id="editCategoryIcon" placeholder="例如: fas fa-link">
                        <div class="form-text">Font Awesome 图标类名</div>
                    </div>
                    <div class="mb-3">
                        <label for="editCategoryOrder" class="form-label">排序</label>
                        <input type="number" class="form-control" id="editCategoryOrder" min="0">
                        <div class="form-text">数字越小排序越靠前</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="updateCategoryBtn">
                    <i class="fas fa-save me-1"></i>
                    更新
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 删除分类确认模态框 -->
<div class="modal fade" id="deleteCategoryConfirmModal" tabindex="-1" aria-labelledby="deleteCategoryConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteCategoryConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    确认删除
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteCategoryConfirmMessage">确定要删除分类吗？</p>
                <input type="hidden" id="deleteCategoryId">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    此操作将同时删除该分类下的所有导航项，且不可撤销。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteCategoryBtn">
                    <i class="fas fa-trash-alt me-1"></i>
                    删除
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 添加导航项模态框 -->
<div class="modal fade" id="addNavItemModal" tabindex="-1" aria-labelledby="addNavItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addNavItemModalLabel">
                    <i class="fas fa-plus me-2"></i>
                    添加导航项
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addNavItemForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="navItemTitle" class="form-label">标题 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="navItemTitle" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="navItemUrl" class="form-label">URL <span class="text-danger">*</span></label>
                                <input type="url" class="form-control" id="navItemUrl" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="navItemDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="navItemDescription" rows="3" placeholder="简要描述这个导航项的用途..."></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="navItemIcon" class="form-label">图标</label>
                                <input type="text" class="form-control" id="navItemIcon" value="fas fa-link" placeholder="例如: fas fa-link">
                                <div class="form-text">Font Awesome 图标类名</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="navItemCategory" class="form-label">分类 <span class="text-danger">*</span></label>
                                <select class="form-select" id="navItemCategory" required>
                                    <option value="">请选择分类</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="navItemOrder" class="form-label">排序</label>
                                <input type="number" class="form-control" id="navItemOrder" value="0" min="0">
                                <div class="form-text">数字越小排序越靠前</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="navItemIsPublic" checked>
                                    <label class="form-check-label" for="navItemIsPublic">
                                        公开显示
                                    </label>
                                    <div class="form-text">是否在前台显示此导航项</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveNavItemBtn">
                    <i class="fas fa-save me-1"></i>
                    保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑导航项模态框 -->
<div class="modal fade" id="editNavItemModal" tabindex="-1" aria-labelledby="editNavItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editNavItemModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    编辑导航项
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editNavItemForm">
                    <input type="hidden" id="editNavItemId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editNavItemTitle" class="form-label">标题 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editNavItemTitle" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editNavItemUrl" class="form-label">URL <span class="text-danger">*</span></label>
                                <input type="url" class="form-control" id="editNavItemUrl" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editNavItemDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="editNavItemDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editNavItemIcon" class="form-label">图标</label>
                                <input type="text" class="form-control" id="editNavItemIcon" placeholder="例如: fas fa-link">
                                <div class="form-text">Font Awesome 图标类名</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editNavItemCategory" class="form-label">分类 <span class="text-danger">*</span></label>
                                <select class="form-select" id="editNavItemCategory" required>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editNavItemOrder" class="form-label">排序</label>
                                <input type="number" class="form-control" id="editNavItemOrder" min="0">
                                <div class="form-text">数字越小排序越靠前</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="editNavItemIsPublic">
                                    <label class="form-check-label" for="editNavItemIsPublic">
                                        公开显示
                                    </label>
                                    <div class="form-text">是否在前台显示此导航项</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="updateNavItemBtn">
                    <i class="fas fa-save me-1"></i>
                    更新
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 删除导航项确认模态框 -->
<div class="modal fade" id="deleteNavItemConfirmModal" tabindex="-1" aria-labelledby="deleteNavItemConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteNavItemConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    确认删除
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteNavItemConfirmMessage">确定要删除导航项吗？</p>
                <input type="hidden" id="deleteNavItemId">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    此操作不可撤销。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteNavItemBtn">
                    <i class="fas fa-trash-alt me-1"></i>
                    删除
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 引用外部JavaScript文件 -->
<script src="{{ url_for('static', filename='js/admin-navigation.js') }}"></script>

<!-- GitHub风格的自定义样式 -->
<style>
.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.border-left-info {
    border-left: 0.25rem solid #36b9cc !important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}

.text-xs {
    font-size: 0.7rem;
}

.font-weight-bold {
    font-weight: 700 !important;
}

.text-uppercase {
    text-transform: uppercase !important;
}

.text-gray-800 {
    color: #5a5c69 !important;
}

.text-gray-600 {
    color: #858796 !important;
}

.text-gray-400 {
    color: #d1d3e2 !important;
}

.text-gray-300 {
    color: #dddfeb !important;
}

.shadow {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
}

.card {
    border: 1px solid #e3e6f0;
    border-radius: 0.35rem;
}

.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
}

.btn-group .btn {
    margin-right: 0;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #5a5c69;
}

.modal-header {
    border-bottom: 1px solid #e3e6f0;
}

.modal-footer {
    border-top: 1px solid #e3e6f0;
}

.form-control:focus {
    border-color: #bac8f3;
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

.btn-primary {
    background-color: #4e73df;
    border-color: #4e73df;
}

.btn-primary:hover {
    background-color: #2e59d9;
    border-color: #2653d4;
}

.text-primary {
    color: #4e73df !important;
}

.bg-primary {
    background-color: #4e73df !important;
}

.badge {
    font-size: 0.75em;
}

.alert {
    border: 1px solid transparent;
    border-radius: 0.35rem;
}

.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .container-fluid {
        padding-left: 1rem;
        padding-right: 1rem;
    }
    
    .d-flex.gap-2 {
        flex-direction: column;
        gap: 0.5rem !important;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group .btn {
        margin-bottom: 0.25rem;
    }
}

/* 动画效果 */
.card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.25rem 2rem 0 rgba(58, 59, 69, 0.2) !important;
}

.btn {
    transition: all 0.2s ease-in-out;
}

.table tbody tr {
    transition: background-color 0.2s ease-in-out;
}

.table tbody tr:hover {
    background-color: #f8f9fc;
}
</style>
{% endblock %}