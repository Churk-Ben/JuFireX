{% extends "base.html" %} {% block title %}注册 - JuFire Studio{% endblock %} {%
block content %}
<div
  class="container d-flex align-items-center justify-content-center"
  style="min-height: 75vh; padding-top: 30px; padding-bottom: 30px"
>
  <div class="row justify-content-center w-100">
    <div class="col-md-10 col-lg-8">
      <div class="card">
        <div class="card-header text-center">
          <h3>
            <i class="fas fa-user-plus me-2" style="font-size: 1.75rem"></i>
            注册账号
          </h3>
        </div>
        <div class="card-body">
          <form method="POST" id="registerForm">
            <div class="row">
              <!-- 左列 -->
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="username" class="form-label">用户名</label>
                  <input
                    type="text"
                    class="form-control"
                    id="username"
                    name="username"
                    required
                    pattern="[a-zA-Z0-9_]{3,20}"
                    title="用户名只能包含字母、数字和下划线，长度3-20位"
                  />
                  <div class="form-text">
                    用户名只能包含字母、数字和下划线，长度3-20位
                  </div>
                </div>

                <div class="mb-3">
                  <label for="email" class="form-label">邮箱</label>
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    name="email"
                    required
                  />
                </div>

                <div class="mb-3">
                  <label for="password" class="form-label">密码</label>
                  <input
                    type="password"
                    title="密码至少6位"
                    class="form-control"
                    id="password"
                    name="password"
                    required
                    minlength="6"
                  />
                  <div class="form-text">密码至少6位</div>
                </div>
              </div>

              <!-- 右列 -->
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="confirm_password" class="form-label"
                    >确认密码</label
                  >
                  <input
                    type="password"
                    class="form-control"
                    id="confirm_password"
                    name="confirm_password"
                    required
                  />
                  <div id="passwordHelp" class="form-text"></div>
                </div>

                <div class="mb-3">
                  <label for="avatar" class="form-label">头像（可选）</label>
                  <div class="d-flex align-items-center mb-2">
                    <div
                      id="avatarPreview"
                      class="me-3"
                      style="
                        width: 80px;
                        height: 80px;
                        border-radius: 50%;
                        background-color: #f0f0f0;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        overflow: hidden;
                        flex-shrink: 0;
                      "
                    >
                      <i
                        class="fas fa-user-circle"
                        style="font-size: 80px; color: #ccc"
                      ></i>
                    </div>
                    <div class="flex-grow-1">
                      <input
                        type="file"
                        class="form-control"
                        id="avatar"
                        name="avatar"
                        accept="image/*"
                      />
                      <div class="form-text">
                        支持JPG、PNG格式，建议使用正方形图片
                      </div>
                    </div>
                  </div>
                </div>

                <div class="mb-3 form-check">
                  <input
                    type="checkbox"
                    class="form-check-input"
                    id="agree"
                    required
                  />
                  <label class="form-check-label" for="agree">
                    我同意遵守工作室的使用条款和隐私政策
                  </label>
                </div>

                <div class="d-grid mt-3">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-user-plus me-2"></i> 注册
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="card-footer text-center">
          <p class="mb-0">
            已有账号？
            <a href="{{ url_for('login') }}" class="text-decoration-none"
              >立即登录</a
            >
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<!-- 引入Cropper.js库 -->
<link
  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css"
  rel="stylesheet"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script src="{{ url_for('static', filename='js/cropper.js') }}"></script>

<script>
  // 头像预览功能
  document.getElementById("avatar").addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      const previewContainer = document.getElementById("avatarPreview");
      // 清空预览容器
      previewContainer.innerHTML = "";

      // 创建图片元素
      const img = document.createElement("img");
      img.src = e.target.result;
      img.style.width = "100%";
      img.style.height = "100%";
      img.style.objectFit = "cover";
      img.style.objectPosition = "center";
      img.style.display = "block";

      // 添加到预览容器
      previewContainer.appendChild(img);
    };
    reader.readAsDataURL(file);
  });

  // 表单提交处理
  document
    .getElementById("registerForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const password = document.getElementById("password").value;
      const confirmPassword = document.getElementById("confirm_password").value;

      if (password !== confirmPassword) {
        alert("两次输入的密码不一致！");
        return false;
      }

      // 创建FormData对象
      const formData = new FormData(this);

      // 发送请求
      fetch("/register", {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
        },
        body: formData,
      })
        .then((response) => {
          if (response.redirected) {
            window.location.href = response.url;
          } else {
            return response.json();
          }
        })
        .then((data) => {
          if (data) {
            if (data.success) {
              // 注册成功，跳转到登录页面
              window.location.href = "{{ url_for('login') }}";
            } else {
              alert(data.message || "注册失败，请重试");
            }
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("注册失败，请重试");
        });
    });

  // 实时检查密码确认
  document
    .getElementById("confirm_password")
    .addEventListener("input", function () {
      const password = document.getElementById("password").value;
      const confirmPassword = this.value;
      const helpText = document.getElementById("passwordHelp");

      if (confirmPassword === "") {
        helpText.textContent = "";
        helpText.className = "form-text";
      } else if (password === confirmPassword) {
        helpText.textContent = "密码匹配 ✓";
        helpText.className = "form-text text-success";
      } else {
        helpText.textContent = "密码不匹配 ✗";
        helpText.className = "form-text text-danger";
      }
    });
</script>
{% endblock %}
