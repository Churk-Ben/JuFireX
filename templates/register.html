{% extends "base.html" %}

{% block title %}
注册 - JuFire Studio
{% endblock %}

{% block content %}
<div class="container d-flex align-items-center justify-content-center"
  style="min-height: 75vh; padding-top: 30px; padding-bottom: 30px">
  <div class="row justify-content-center w-100">
    <div class="col-md-10 col-lg-8">
      <div class="card">
        <div class="card-header text-center">
          <h3>
            <i class="fas fa-user-plus me-2" style="font-size: 1.75rem"></i>
            创建账号
          </h3>
          <div class="mt-2 mb-0 d-flex justify-content-center">
            <div class="progress" style="height: 4px; width: 60%;">
              <div class="progress-bar bg-success" role="progressbar" style="width: 0%;" id="registerProgress"></div>
            </div>
          </div>
        </div>
        <div class="card-body">
          <form method="POST" id="registerForm" enctype="multipart/form-data">
            <!-- 步骤指示器 -->
            <div class="mb-4 d-flex justify-content-between">
              <div class="step active" id="step1Indicator">
                <div class="step-circle">
                  <i class="fas fa-user"></i>
                </div>
                <div class="step-text">账号信息</div>
              </div>
              <div class="step" id="step2Indicator">
                <div class="step-circle">
                  <i class="fas fa-lock"></i>
                </div>
                <div class="step-text">安全设置</div>
              </div>
              <div class="step" id="step3Indicator">
                <div class="step-circle">
                  <i class="fas fa-image"></i>
                </div>
                <div class="step-text">个人资料</div>
              </div>
            </div>

            <!-- 步骤1：账号信息 -->
            <div id="step1" class="step-content active">
              <div class="mb-4">
                <label for="username" class="form-label">用户名</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-user"></i></span>
                  <input type="text" class="form-control" id="username" name="username" required
                    pattern="[a-zA-Z0-9_]{3,20}" title="用户名只能包含字母、数字和下划线，长度3-20位" placeholder="设置您的用户名" />
                </div>
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>用户名只能包含字母、数字和下划线，长度3-20位
                </div>
                <div id="usernameValidation" class="invalid-feedback"></div>
              </div>

              <div class="mb-4">
                <label for="email" class="form-label">电子邮箱</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                  <input type="email" class="form-control" id="email" name="email" required placeholder="您的电子邮箱地址" />
                </div>
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>我们不会向您发送垃圾邮件
                </div>
                <div id="emailValidation" class="invalid-feedback"></div>
              </div>

              <div class="d-flex justify-content-end mt-4">
                <button type="button" class="btn btn-primary" id="nextToStep2">
                  下一步<i class="fas fa-arrow-right ms-2"></i>
                </button>
              </div>
            </div>

            <!-- 步骤2：安全设置 -->
            <div id="step2" class="step-content">
              <div class="mb-4">
                <label for="password" class="form-label">密码</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-lock"></i></span>
                  <input type="password" class="form-control" id="password" name="password" required minlength="6"
                    placeholder="设置您的密码" />
                  <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>密码至少6位，建议使用字母、数字和符号的组合
                </div>
                <div class="mt-2 password-strength-meter">
                  <div class="progress" style="height: 5px;">
                    <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%;"></div>
                  </div>
                  <small id="passwordStrengthText" class="form-text mt-1">密码强度: 未设置</small>
                </div>
              </div>

              <div class="mb-4">
                <label for="confirm_password" class="form-label">确认密码</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-check-circle"></i></span>
                  <input type="password" class="form-control" id="confirm_password" name="confirm_password" required
                    placeholder="再次输入密码" />
                </div>
                <div id="passwordHelp" class="form-text"></div>
              </div>

              <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-primary" id="backToStep1">
                  <i class="fas fa-arrow-left me-2"></i>上一步
                </button>
                <button type="button" class="btn btn-primary" id="nextToStep3">
                  下一步<i class="fas fa-arrow-right ms-2"></i>
                </button>
              </div>
            </div>

            <!-- 步骤3：个人资料 -->
            <div id="step3" class="step-content">
              <div class="mb-4 text-center">
                <label for="avatar" class="form-label d-block">选择头像</label>
                <div class="d-flex justify-content-center mb-3">
                  <div id="avatarPreview" style="
                      width: 120px;
                      height: 120px;
                      border-radius: 50%;
                      background-color: var(--github-secondary);
                      border: 2px solid var(--github-border);
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      overflow: hidden;
                      cursor: pointer;
                      transition: all 0.2s ease;
                    " onclick="document.getElementById('avatar').click();">
                    <i class="fas fa-user-circle" style="font-size: 100px; color: var(--github-border)"></i>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="input-group">
                    <input type="file" class="form-control" id="avatar" name="avatar" accept="image/*"
                      style="display: none;" />
                    <button type="button" class="btn btn-outline-primary mx-auto rounded"
                      onclick="document.getElementById('avatar').click();">
                      <i class="fas fa-upload me-2"></i>上传头像
                    </button>
                  </div>
                  <div class="form-text text-center mt-2">
                    <i class="fas fa-info-circle me-1"></i>支持JPG、PNG格式，建议使用正方形图片
                  </div>
                </div>
              </div>

              <!-- 裁剪容器将移至模态框 -->

              <div class="mb-4 form-check">
                <input type="checkbox" class="form-check-input" id="agree" required />
                <label class="form-check-label" for="agree">
                  我已阅读并同意遵守<a href="#" class="text-decoration-none">使用条款</a>和<a href="#"
                    class="text-decoration-none">隐私政策</a>
                </label>
              </div>

              <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-primary" id="backToStep2">
                  <i class="fas fa-arrow-left me-2"></i>上一步
                </button>
                <button type="submit" class="btn btn-success">
                  <i class="fas fa-user-plus me-2"></i>完成注册
                </button>
              </div>
            </div>
          </form>
        </div>
        <div class="card-footer text-center">
          <p class="mb-0">
            已有账号？
            <a href="{{ url_for('login') }}" class="text-decoration-none">立即登录</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 头像裁剪容器 -->
<input type="hidden" id="croppedAvatarData" name="croppedAvatarData" />

<!-- 头像上传模态框 -->
<div class="modal fade" id="avatarModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-camera"></i> 上传头像</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
          style="background-color: var(--github-accent)"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-12 text-center mb-3">
            <div id="modalAvatarPreview" style="
                width: 120px;
                height: 120px;
                border-radius: 50%;
                background-color: #f0f0f0;
                margin: 0 auto;
                overflow: hidden;
              ">
              <i class="fas fa-user" style="font-size: 4rem; color: #ccc; line-height: 120px"></i>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label for="avatarUpload" class="form-label">选择图片</label>
          <input class="form-control" type="file" id="avatarUpload" accept="image/*" />
          <div class="form-text">支持JPG、PNG格式，建议使用正方形图片</div>
        </div>

        <!-- 裁剪区域 -->
        <div id="cropperContainer" style="display: none; max-height: 300px; overflow: hidden" class="mb-3"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelCropBtn" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="cropBtn">裁剪</button>
        <button type="button" class="btn btn-success" id="saveAvatarBtn"><i class="fas fa-save"></i> 保存头像</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- 引入Cropper.js库 -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script src="{{ url_for('static', filename='js/cropper.js') }}"></script>

<style>
  /* 步骤指示器样式 */
  .step {
    text-align: center;
    position: relative;
    flex: 1;
  }

  .step-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--github-secondary);
    border: 2px solid var(--github-border);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    color: var(--github-text-secondary);
    font-size: 1.2rem;
    transition: all 0.3s ease;
  }

  .step.active .step-circle {
    background-color: var(--github-accent);
    border-color: var(--github-accent);
    color: white;
    transform: scale(1.1);
    box-shadow: 0 0 15px rgba(88, 166, 255, 0.5);
  }

  .step.completed .step-circle {
    background-color: var(--github-success);
    border-color: var(--github-success);
    color: white;
  }

  .step-text {
    font-size: 0.9rem;
    color: var(--github-text-secondary);
    transition: all 0.3s ease;
  }

  .step.active .step-text {
    color: var(--github-accent);
    font-weight: 600;
  }

  .step.completed .step-text {
    color: var(--github-success);
  }

  /* 步骤内容样式 */
  .step-content {
    display: none;
    animation: fadeIn 0.5s ease;
  }

  .step-content.active {
    display: block;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  // 全局变量
  let currentStep = 1;
  let cropper = null;

  // 初始化
  initStepButtons();
  initPasswordStrengthMeter();
  initPasswordToggle();
  initAvatarUpload();
  initFormValidation();

  // 初始化步骤切换按钮
  function initStepButtons() {
    // 步骤1到步骤2
    document.getElementById('nextToStep2').addEventListener('click', function () {
      // 验证第一步表单
      if (!validateStep1()) return;

      goToStep(2);
    });

    // 步骤2到步骤1
    document.getElementById('backToStep1').addEventListener('click', function () {
      goToStep(1);
    });

    // 步骤2到步骤3
    document.getElementById('nextToStep3').addEventListener('click', function () {
      // 验证第二步表单
      if (!validateStep2()) return;

      goToStep(3);
    });

    // 步骤3到步骤2
    document.getElementById('backToStep2').addEventListener('click', function () {
      goToStep(2);
    });
  }

  // 切换到指定步骤
  function goToStep(step) {
    // 隐藏所有步骤内容
    document.querySelectorAll('.step-content').forEach(function (el) {
      el.classList.remove('active');
    });

    // 显示当前步骤内容
    document.getElementById('step' + step).classList.add('active');

    // 更新步骤指示器
    document.querySelectorAll('.step').forEach(function (el, index) {
      el.classList.remove('active', 'completed');

      if (index + 1 < step) {
        el.classList.add('completed');
      } else if (index + 1 === step) {
        el.classList.add('active');
      }
    });

    // 更新进度条
    const progressBar = document.getElementById('registerProgress');
    progressBar.style.width = ((step - 1) / 2 * 100) + '%';

    // 更新当前步骤
    currentStep = step;
  }

  // 验证第一步表单
  function validateStep1() {
    const username = document.getElementById('username');
    const email = document.getElementById('email');
    let isValid = true;

    // 验证用户名
    if (!username.checkValidity()) {
      document.getElementById('usernameValidation').textContent = '请输入有效的用户名';
      document.getElementById('usernameValidation').style.display = 'block';
      username.classList.add('is-invalid');
      isValid = false;
    } else {
      username.classList.remove('is-invalid');
      username.classList.add('is-valid');
    }

    // 验证邮箱
    if (!email.checkValidity()) {
      document.getElementById('emailValidation').textContent = '请输入有效的电子邮箱地址';
      document.getElementById('emailValidation').style.display = 'block';
      email.classList.add('is-invalid');
      isValid = false;
    } else {
      email.classList.remove('is-invalid');
      email.classList.add('is-valid');
    }

    return isValid;
  }

  // 验证第二步表单
  function validateStep2() {
    const password = document.getElementById('password');
    const confirmPassword = document.getElementById('confirm_password');
    let isValid = true;

    // 验证密码
    if (!password.checkValidity() || password.value.length < 6) {
      password.classList.add('is-invalid');
      isValid = false;
    } else {
      password.classList.remove('is-invalid');
      password.classList.add('is-valid');
    }

    // 验证确认密码
    if (password.value !== confirmPassword.value) {
      confirmPassword.classList.add('is-invalid');
      document.getElementById('passwordHelp').textContent = '密码不匹配 ✗';
      document.getElementById('passwordHelp').className = 'form-text text-danger';
      isValid = false;
    } else if (confirmPassword.value.length > 0) {
      confirmPassword.classList.remove('is-invalid');
      confirmPassword.classList.add('is-valid');
      document.getElementById('passwordHelp').textContent = '密码匹配 ✓';
      document.getElementById('passwordHelp').className = 'form-text text-success';
    }

    return isValid;
  }

  // 初始化密码强度检测
  function initPasswordStrengthMeter() {
    const password = document.getElementById('password');
    const strengthBar = document.getElementById('passwordStrength');
    const strengthText = document.getElementById('passwordStrengthText');

    password.addEventListener('input', function () {
      const value = password.value;
      let strength = 0;

      // 密码长度检查
      if (value.length >= 6) strength += 1;
      if (value.length >= 10) strength += 1;

      // 包含数字检查
      if (/\d/.test(value)) strength += 1;

      // 包含小写字母检查
      if (/[a-z]/.test(value)) strength += 1;

      // 包含大写字母检查
      if (/[A-Z]/.test(value)) strength += 1;

      // 包含特殊字符检查
      if (/[^a-zA-Z0-9]/.test(value)) strength += 1;

      // 更新强度条
      let percentage = (strength / 6) * 100;
      strengthBar.style.width = percentage + '%';

      // 更新强度文本和颜色
      if (value.length === 0) {
        strengthBar.className = 'progress-bar';
        strengthText.textContent = '密码强度: 未设置';
      } else if (percentage < 30) {
        strengthBar.className = 'progress-bar bg-danger';
        strengthText.textContent = '密码强度: 弱';
      } else if (percentage < 60) {
        strengthBar.className = 'progress-bar bg-warning';
        strengthText.textContent = '密码强度: 中';
      } else {
        strengthBar.className = 'progress-bar bg-success';
        strengthText.textContent = '密码强度: 强';
      }
    });
  }

  // 初始化密码可见性切换
  function initPasswordToggle() {
    const toggleBtn = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');

    toggleBtn.addEventListener('click', function () {
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);

      // 切换图标
      const icon = toggleBtn.querySelector('i');
      if (type === 'text') {
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    });
  }

  // 初始化头像上传和裁剪
  function initAvatarUpload() {
    const avatarInput = document.getElementById('avatar');
    const previewContainer = document.getElementById('avatarPreview');
    const modalPreviewContainer = document.getElementById('modalAvatarPreview');
    const cropperContainer = document.getElementById('cropperContainer');
    const cropBtn = document.getElementById('cropBtn');
    const cancelCropBtn = document.getElementById('cancelCropBtn');
    const saveAvatarBtn = document.getElementById('saveAvatarBtn');
    const croppedAvatarData = document.getElementById('croppedAvatarData');
    const avatarUpload = document.getElementById('avatarUpload');

    // 初始化模态框
    const avatarModal = new bootstrap.Modal(document.getElementById('avatarModal'));

    // 点击头像预览区域打开模态框
    previewContainer.addEventListener('click', function () {
      avatarModal.show();
    });

    // 点击上传头像按钮打开模态框
    document.querySelector('.btn-outline-primary[onclick="document.getElementById(\'avatar\').click();"]')
      .addEventListener('click', function (e) {
        e.preventDefault();
        avatarModal.show();
      });

    // 监听文件选择
    avatarUpload.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      // 检查文件类型
      if (!file.type.match('image.*')) {
        showNotification('请选择图片文件！', 'error');
        return;
      }

      // 创建文件阅读器
      const reader = new FileReader();
      reader.onload = function (e) {
        // 显示裁剪容器
        cropperContainer.style.display = 'block';

        // 创建图片元素
        cropperContainer.innerHTML = '';

        const img = document.createElement('img');
        img.id = 'cropperImage';
        img.src = e.target.result;
        img.style.maxWidth = '100%';
        cropperContainer.appendChild(img);

        // 初始化裁剪器
        if (cropper) {
          cropper.destroy();
        }

        cropper = new Cropper(img, {
          aspectRatio: 1,
          viewMode: 1,
          dragMode: 'move',
          autoCropArea: 0.8,
          restore: false,
          guides: true,
          center: true,
          highlight: true,
          cropBoxMovable: true,
          cropBoxResizable: true,
          toggleDragModeOnDblclick: false,
          background: true,
          modal: true,
        });

        // 显示裁剪和保存按钮，隐藏取消按钮
        cropBtn.style.display = 'inline-block';
        saveAvatarBtn.style.display = 'none';
      };

      reader.readAsDataURL(file);
    });

    // 裁剪按钮点击事件
    cropBtn.addEventListener('click', function () {
      if (!cropper) return;

      // 获取裁剪后的图像
      const canvas = cropper.getCroppedCanvas({
        width: 200,
        height: 200,
        minWidth: 100,
        minHeight: 100,
        maxWidth: 500,
        maxHeight: 500,
        fillColor: '#fff',
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
      });

      // 转换为base64
      const croppedImageUrl = canvas.toDataURL('image/jpeg');

      // 显示预览
      modalPreviewContainer.innerHTML = '';
      const modalImg = document.createElement('img');
      modalImg.src = croppedImageUrl;
      modalImg.style.width = '100%';
      modalImg.style.height = '100%';
      modalImg.style.objectFit = 'cover';
      modalPreviewContainer.appendChild(modalImg);

      // 设置隐藏输入值
      croppedAvatarData.value = croppedImageUrl;

      // 隐藏裁剪容器和裁剪按钮，显示保存按钮
      cropperContainer.style.display = 'none';
      cropBtn.style.display = 'none';
      saveAvatarBtn.style.display = 'inline-block';

      // 销毁裁剪器
      cropper.destroy();
      cropper = null;
    });

    // 取消裁剪按钮点击事件
    cancelCropBtn.addEventListener('click', function () {
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }

      // 隐藏裁剪容器
      cropperContainer.style.display = 'none';
    });

    // 保存头像按钮点击事件
    saveAvatarBtn.addEventListener('click', function () {
      const croppedData = croppedAvatarData.value;
      if (!croppedData) {
        showNotification('请先选择并裁剪图片', 'error');
        return;
      }

      // 更新主页面的头像预览
      previewContainer.innerHTML = '';
      const img = document.createElement('img');
      img.src = croppedData;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
      previewContainer.appendChild(img);

      // 关闭模态框
      avatarModal.hide();

      // 显示成功消息
      showNotification('头像设置成功', 'success');
    });
  }

  // 初始化表单验证
  function initFormValidation() {
    // 实时检查密码确认
    document.getElementById('confirm_password').addEventListener('input', function () {
      const password = document.getElementById('password').value;
      const confirmPassword = this.value;
      const helpText = document.getElementById('passwordHelp');

      if (confirmPassword === '') {
        helpText.textContent = '';
        helpText.className = 'form-text';
        this.classList.remove('is-valid', 'is-invalid');
      } else if (password === confirmPassword) {
        helpText.textContent = '密码匹配 ✓';
        helpText.className = 'form-text text-success';
        this.classList.remove('is-invalid');
        this.classList.add('is-valid');
      } else {
        helpText.textContent = '密码不匹配 ✗';
        helpText.className = 'form-text text-danger';
        this.classList.remove('is-valid');
        this.classList.add('is-invalid');
      }
    });

    // 表单提交处理
    document.getElementById('registerForm').addEventListener('submit', function (e) {
      e.preventDefault();

      // 验证第三步
      const agreeCheckbox = document.getElementById('agree');
      if (!agreeCheckbox.checked) {
        showNotification('请阅读并同意使用条款和隐私政策', 'error');
        return false;
      }

      // 验证密码匹配
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirm_password').value;
      if (password !== confirmPassword) {
        showNotification('两次输入的密码不一致！', 'error');
        return false;
      }

      // 创建FormData对象
      const formData = new FormData(this);

      // 如果有裁剪后的头像数据，添加到表单
      const croppedAvatarData = document.getElementById('croppedAvatarData').value;
      if (croppedAvatarData) {
        // 移除原始文件输入，因为我们将使用裁剪后的数据
        formData.delete('avatar');

        // 将Base64转换为Blob
        const byteString = atob(croppedAvatarData.split(',')[1]);
        const mimeString = croppedAvatarData.split(',')[0].split(':')[1].split(';')[0];
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
        }
        const blob = new Blob([ab], { type: mimeString });
        formData.append('avatar', blob, 'avatar.jpg');
      }

      // 显示加载状态
      const submitBtn = document.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>处理中...';
      submitBtn.disabled = true;

      // 发送请求
      fetch('/register', {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: formData,
      })
        .then(response => {
          // 首先检查是否是重定向响应
          if (response.redirected) {
            // 显示成功消息
            showNotification('注册成功！正在跳转到登录页面...', 'success');

            // 直接跳转到重定向的URL
            setTimeout(() => {
              window.location.href = response.url;
            }, 1500);
            return null; // 返回null，不继续处理
          } else {
            return response.json();
          }
        })
        .then(data => {
          // 如果是重定向响应，data将为null
          if (data === null) return;

          if (data.success) {
            // 注册成功，显示成功消息
            showNotification('注册成功！正在跳转到登录页面...', 'success');

            // 延迟跳转到登录页面
            setTimeout(() => {
              window.location.href = "{{ url_for('login') }}";
            }, 1500);
          } else {
            // 恢复按钮状态
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;

            // 显示错误消息
            showNotification(data.message || '注册失败，请重试', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);

          // 恢复按钮状态
          submitBtn.innerHTML = originalBtnText;
          submitBtn.disabled = false;

          // 显示错误消息
          showNotification('注册失败，请重试', 'error');
        });
    });
  }

  // 显示通知消息
  function showNotification(message, type = 'info') {
    // 检查是否存在全局showNotification函数
    if (typeof window.showNotification === 'function' && window.showNotification !== showNotification) {
      window.showNotification(message, type);
    } else {
      // 如果不存在，使用alert作为备选
      if (type === 'error') {
        alert('错误: ' + message);
      } else {
        alert(message);
      }
    }
  }
</script>
{% endblock %}