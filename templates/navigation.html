{% extends "base.html" %}

{% block title %}导航管理 - JuFire Studio{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-compass"></i> 导航管理</h2>
                <div>
                    {% if current_user.role >= 2 %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNavItemModal">
                        <i class="fas fa-plus"></i> 添加导航
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 导航统计 -->
    <div class="row mb-4">
        <div class="col-md-3 col-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-folder" style="font-size: 2rem; color: var(--github-accent);"></i>
                    <h4 class="mt-2 mb-0">{{ categories|length }}</h4>
                    <p class="text-muted mb-0">总分类数</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-link" style="font-size: 2rem; color: var(--github-success);"></i>
                    <h4 class="mt-2 mb-0">{{ nav_items_by_category.values()|map('length')|sum|default(0) }}</h4>
                    <p class="text-muted mb-0">总导航数</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-eye" style="font-size: 2rem; color: var(--github-warning);"></i>
                    <h4 class="mt-2 mb-0" id="publicCount">0</h4>
                    <p class="text-muted mb-0">公开导航</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-eye-slash" style="font-size: 2rem; color: var(--github-danger);"></i>
                    <h4 class="mt-2 mb-0" id="privateCount">0</h4>
                    <p class="text-muted mb-0">私有导航</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 分类列表 -->
    {% if categories %}
    {% for category in categories %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="{{ category.icon }}"></i> {{ category.name }}
                <span class="badge bg-primary ms-2">{{ nav_items_by_category.get(category.id, [])|length }}</span>
            </h5>
            <div class="input-group" style="width: 300px;">
                <input type="text" class="form-control category-search" placeholder="搜索{{ category.name }}..." data-category-id="{{ category.id }}">
                <button class="btn btn-outline-primary" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            {% if nav_items_by_category.get(category.id, []) %}
            <div class="table-responsive">
                <table class="table table-hover category-table" data-category-id="{{ category.id }}">
                    <thead>
                        <tr>
                            <th>导航信息</th>
                            <th>URL</th>
                            <th>状态</th>
                            <th>创建者</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in nav_items_by_category.get(category.id, [])|sort(attribute='order') %}
                        <tr data-nav-item-id="{{ item.id }}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="{{ item.icon or 'fas fa-link' }}" style="font-size: 1.5rem; color: var(--github-accent);"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">{{ item.title }}</h6>
                                        {% if item.description %}
                                        <small class="text-muted">{{ item.description[:50] }}{% if item.description|length > 50 %}...{% endif %}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <a href="{{ item.url }}" target="_blank" class="text-decoration-none">
                                    {{ item.url[:30] }}{% if item.url|length > 30 %}...{% endif %}
                                    <i class="fas fa-external-link-alt ms-1"></i>
                                </a>
                            </td>
                            <td>
                                {% if item.is_public %}
                                <span class="badge bg-success">公开</span>
                                {% else %}
                                <span class="badge bg-warning">私有</span>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">
                                    <i class="fas fa-user"></i> {{ item.creator.username if item.creator else '未知' }}
                                </small>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    {% if current_user.role >= 2 or (item.creator and item.creator.id == current_user.id) %}
                                    <button class="btn btn-sm btn-outline-primary edit-nav-item" 
                                        data-item-id="{{ item.id }}"
                                        data-item-title="{{ item.title }}"
                                        data-item-url="{{ item.url }}"
                                        data-item-description="{{ item.description or '' }}"
                                        data-item-icon="{{ item.icon or '' }}"
                                        data-item-category-id="{{ item.category_id }}"
                                        data-item-is-public="{{ item.is_public|lower }}"
                                        data-item-order="{{ item.order }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    {% endif %}
                                    {% if current_user.role >= 2 or (item.creator and item.creator.id == current_user.id) %}
                                    <button class="btn btn-sm btn-outline-danger delete-nav-item" 
                                        data-item-id="{{ item.id }}"
                                        data-item-title="{{ item.title }}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    {% endif %}
                                    {% if item.creator and item.creator.id != current_user.id %}
                                    <button class="btn btn-sm btn-outline-secondary toggle-visibility" 
                                        data-item-id="{{ item.id }}"
                                        data-is-public="{{ (item.id not in hidden_nav_items)|lower }}">
                                        {% if item.id in hidden_nav_items %}
                                        <i class="fas fa-eye"></i>
                                        {% else %}
                                        <i class="fas fa-eye-slash"></i>
                                        {% endif %}
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 该分类下暂无导航项
                {% if current_user.role >= 2 %}
                <button class="btn btn-sm btn-primary ms-2 add-to-category" data-category-id="{{ category.id }}" data-category-name="{{ category.name }}">
                    <i class="fas fa-plus"></i> 添加导航项
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> 暂无导航分类
    </div>
    {% endif %}
</div>

<!-- 添加导航项模态框 -->
<div class="modal fade" id="addNavItemModal" tabindex="-1" aria-labelledby="addNavItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addNavItemModalLabel">
                    <i class="fas fa-plus"></i> 添加导航项
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addNavItemForm" novalidate>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="navItemTitle" class="form-label">
                                    <i class="fas fa-heading"></i> 标题 <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="navItemTitle" required>
                                <div class="invalid-feedback">请输入导航标题</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="navItemUrl" class="form-label">
                                    <i class="fas fa-link"></i> URL <span class="text-danger">*</span>
                                </label>
                                <input type="url" class="form-control" id="navItemUrl" required>
                                <div class="invalid-feedback">请输入有效的URL</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="navItemDescription" class="form-label">
                            <i class="fas fa-align-left"></i> 描述
                        </label>
                        <textarea class="form-control" id="navItemDescription" rows="3" placeholder="简要描述这个导航项的用途..."></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="navItemCategory" class="form-label">
                                    <i class="fas fa-folder"></i> 分类 <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="navItemCategory" required>
                                    <option value="">请选择分类</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">请选择一个分类</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="navItemIcon" class="form-label">
                                    <i class="fas fa-icons"></i> 图标
                                </label>
                                <input type="text" class="form-control" id="navItemIcon" placeholder="例如: fas fa-link">
                                <small class="form-text text-muted">Font Awesome 图标类名</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-eye"></i> 可见性
                                </label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="navItemIsPublic" checked>
                                    <label class="form-check-label" for="navItemIsPublic">
                                        <span class="public-text">公开 - 所有用户可见</span>
                                        <span class="private-text" style="display: none;">私有 - 仅自己可见</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="navItemOrder" class="form-label">
                                    <i class="fas fa-sort"></i> 排序
                                </label>
                                <input type="number" class="form-control" id="navItemOrder" value="0" min="0">
                                <small class="form-text text-muted">数字越小排序越靠前</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button type="button" class="btn btn-primary" id="saveNavItemBtn">
                    <i class="fas fa-save"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑导航项模态框 -->
<div class="modal fade" id="editNavItemModal" tabindex="-1" aria-labelledby="editNavItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editNavItemModalLabel">
                    <i class="fas fa-edit"></i> 编辑导航项
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editNavItemForm" novalidate>
                    <input type="hidden" id="editNavItemId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editNavItemTitle" class="form-label">
                                    <i class="fas fa-heading"></i> 标题 <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="editNavItemTitle" required>
                                <div class="invalid-feedback">请输入导航标题</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editNavItemUrl" class="form-label">
                                    <i class="fas fa-link"></i> URL <span class="text-danger">*</span>
                                </label>
                                <input type="url" class="form-control" id="editNavItemUrl" required>
                                <div class="invalid-feedback">请输入有效的URL</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editNavItemDescription" class="form-label">
                            <i class="fas fa-align-left"></i> 描述
                        </label>
                        <textarea class="form-control" id="editNavItemDescription" rows="3"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editNavItemCategory" class="form-label">
                                    <i class="fas fa-folder"></i> 分类 <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="editNavItemCategory" required>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">请选择一个分类</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editNavItemIcon" class="form-label">
                                    <i class="fas fa-icons"></i> 图标
                                </label>
                                <input type="text" class="form-control" id="editNavItemIcon">
                                <small class="form-text text-muted">Font Awesome 图标类名</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-eye"></i> 可见性
                                </label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editNavItemIsPublic">
                                    <label class="form-check-label" for="editNavItemIsPublic">
                                        <span class="edit-public-text">公开 - 所有用户可见</span>
                                        <span class="edit-private-text" style="display: none;">私有 - 仅自己可见</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editNavItemOrder" class="form-label">
                                    <i class="fas fa-sort"></i> 排序
                                </label>
                                <input type="number" class="form-control" id="editNavItemOrder" min="0">
                                <small class="form-text text-muted">数字越小排序越靠前</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button type="button" class="btn btn-warning" id="updateNavItemBtn">
                    <i class="fas fa-save"></i> 更新
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteNavItemModal" tabindex="-1" aria-labelledby="deleteNavItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteNavItemModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> 确认删除
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteNavItemConfirmMessage">您确定要删除导航项吗？</p>
                <input type="hidden" id="deleteNavItemId">
                <p class="text-muted">此操作不可撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteNavItemBtn">
                    <i class="fas fa-trash-alt"></i> 删除
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 初始化统计数据
    updateStatistics();
    
    // 搜索功能
    $('.category-search').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        const categoryId = $(this).data('category-id');
        const table = $(`.category-table[data-category-id="${categoryId}"]`);
        
        table.find('tbody tr').each(function() {
            const text = $(this).text().toLowerCase();
            $(this).toggle(text.includes(searchTerm));
        });
    });
    
    // 可见性切换开关
    $('#navItemIsPublic, #editNavItemIsPublic').change(function() {
        const isPublic = $(this).is(':checked');
        const modal = $(this).closest('.modal');
        
        if (isPublic) {
            modal.find('.public-text, .edit-public-text').show();
            modal.find('.private-text, .edit-private-text').hide();
        } else {
            modal.find('.public-text, .edit-public-text').hide();
            modal.find('.private-text, .edit-private-text').show();
        }
    });
    
    // 添加到分类按钮
    $('.add-to-category').click(function() {
        const categoryId = $(this).data('category-id');
        const categoryName = $(this).data('category-name');
        
        $('#navItemCategory').val(categoryId);
        $('#addNavItemModal').modal('show');
    });
    
    // 保存导航项
    $('#saveNavItemBtn').click(function() {
        const form = $('#addNavItemForm')[0];
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }
        
        const data = {
            title: $('#navItemTitle').val(),
            url: $('#navItemUrl').val(),
            description: $('#navItemDescription').val(),
            icon: $('#navItemIcon').val(),
            category_id: $('#navItemCategory').val(),
            is_public: $('#navItemIsPublic').is(':checked'),
            order: parseInt($('#navItemOrder').val()) || 0
        };
        
        $.ajax({
            url: '/api/nav-items',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                showNotification('导航项添加成功', 'success');
                $('#addNavItemModal').modal('hide');
                location.reload();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || '添加失败';
                showNotification(error, 'error');
            }
        });
    });
    
    // 编辑导航项
    $('.edit-nav-item').click(function() {
        const data = $(this).data();
        
        $('#editNavItemId').val(data.navItemId);
        $('#editNavItemTitle').val(data.title);
        $('#editNavItemUrl').val(data.url);
        $('#editNavItemDescription').val(data.description);
        $('#editNavItemIcon').val(data.icon);
        $('#editNavItemCategory').val(data.categoryId);
        $('#editNavItemIsPublic').prop('checked', data.isPublic === 'true').trigger('change');
        $('#editNavItemOrder').val(data.order);
        
        $('#editNavItemModal').modal('show');
    });
    
    // 更新导航项
    $('#updateNavItemBtn').click(function() {
        const form = $('#editNavItemForm')[0];
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }
        
        const navItemId = $('#editNavItemId').val();
        const data = {
            title: $('#editNavItemTitle').val(),
            url: $('#editNavItemUrl').val(),
            description: $('#editNavItemDescription').val(),
            icon: $('#editNavItemIcon').val(),
            category_id: $('#editNavItemCategory').val(),
            is_public: $('#editNavItemIsPublic').is(':checked'),
            order: parseInt($('#editNavItemOrder').val()) || 0
        };
        
        $.ajax({
            url: `/api/nav-items/${navItemId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                showNotification('导航项更新成功', 'success');
                $('#editNavItemModal').modal('hide');
                location.reload();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || '更新失败';
                showNotification(error, 'error');
            }
        });
    });
    
    // 删除导航项
    $('.delete-nav-item').click(function() {
        const navItemId = $(this).data('nav-item-id');
        const navItemTitle = $(this).data('nav-item-title');
        
        $('#deleteNavItemName').text(navItemTitle);
        $('#confirmDeleteNavItemBtn').data('nav-item-id', navItemId);
        $('#deleteNavItemModal').modal('show');
    });
    
    // 确认删除
    $('#confirmDeleteNavItemBtn').click(function() {
        const navItemId = $(this).data('nav-item-id');
        
        $.ajax({
            url: `/api/nav-items/${navItemId}`,
            method: 'DELETE',
            success: function(response) {
                showNotification('导航项删除成功', 'success');
                $('#deleteNavItemModal').modal('hide');
                location.reload();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || '删除失败';
                showNotification(error, 'error');
            }
        });
    });
    
    // 切换可见性
    $('.toggle-visibility').click(function() {
        const navItemId = $(this).data('nav-item-id');
        const isHidden = $(this).data('is-hidden');
        
        $.ajax({
            url: `/api/nav-items/${navItemId}/toggle-visibility`,
            method: 'POST',
            success: function(response) {
                const message = isHidden ? '导航项已显示' : '导航项已隐藏';
                showNotification(message, 'success');
                location.reload();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || '操作失败';
                showNotification(error, 'error');
            }
        });
    });
    
    // 更新统计数据
    function updateStatistics() {
        let publicCount = 0;
        let privateCount = 0;
        
        $('.category-table tbody tr').each(function() {
            const badge = $(this).find('.badge');
            if (badge.hasClass('bg-success')) {
                publicCount++;
            } else if (badge.hasClass('bg-warning')) {
                privateCount++;
            }
        });
        
        $('#publicCount').text(publicCount);
        $('#privateCount').text(privateCount);
    }
    
    // 显示通知
    function showNotification(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        const notification = $(`
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="fas ${icon}"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(notification);
        
        setTimeout(() => {
            notification.alert('close');
        }, 3000);
    }
    
    // 清理表单
    $('.modal').on('hidden.bs.modal', function() {
        $(this).find('form')[0]?.reset();
        $(this).find('.was-validated').removeClass('was-validated');
        $(this).find('.public-text, .edit-public-text').show();
        $(this).find('.private-text, .edit-private-text').hide();
    });
});
</script>

<!-- 引用外部JavaScript文件 -->
<script src="{{ url_for('static', filename='js/admin-navigation.js') }}"></script>
{% endblock %}