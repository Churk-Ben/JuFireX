{% extends "base.html" %}

{% block title %}
导航站 - JuFire Studio
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-compass"></i> 工作室导航</h2>
        {% if current_user %}
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#manageCardsModal">
          <i class="fas fa-th-large"></i> 卡片管理
        </button>
        {% endif %}
      </div>
    </div>
  </div>

  {% if categories %}
  {% for category in categories %}
  {% if nav_items_by_category.get(category.id) %}
  <div class="mb-4">
    <h4 class="category-title">
      <i class="{{ category.icon }}"></i> {{ category.name }}
    </h4>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      {% for item in nav_items_by_category.get(category.id,[])|sort(attribute='order') %}
      <div class="col nav-card-col" data-nav-item-id="{{ item.id }}">
        <div class="card h-100 nav-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h5 class="card-title">{{ item.title }}</h5>
              <div class="dropdown">
                <button class="btn btn-sm btn-icon" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item hide-card-btn" onclick="hideCard('{{ item.id }}'); return false;"
                      href="javascript:void(0);">
                      隐藏
                    </a>
                  </li>
                  {% if current_user and item.created_by == current_user.id %}
                  <li>
                    <hr class="dropdown-divider" />
                  </li>
                  <li>
                    {% set is_public %}
                    {% if item.is_public %}
                    {% set is_public = 'true' %}
                    {% else %}
                    {% set is_public = 'false' %}
                    {% endif %}
                    {% endset %}
                    <a class="dropdown-item toggle-privacy-btn" onclick="
                        togglePrivacy('{{ item.id }}', {{ is_public }}, this);
                        return false;
                      " href="javascript:void(0);" data-is-public="{{ is_public }}">
                      {% if item.is_public %}
                      设为私有
                      {% else %}
                      设为公开
                      {% endif %}
                    </a>
                  </li>
                  {% endif %}
                </ul>
              </div>
            </div>
            <p class="card-text text-muted">
              {{ item.description or '暂无描述' }}
            </p>
          </div>
          <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                {% if item.creator and item.creator.avatar_path %}
                <img src="{{ url_for('user_avatar', filename=item.creator.avatar_path) }}" class="avatar-sm me-2"
                  alt="{{ item.creator.username }}" />
                {% else %}
                <i class="fas fa-user-circle avatar-sm me-2"></i>
                {% endif %}
                <div>
                  <small class="text-white">
                    {% if item.creator %}
                    {{ item.creator.username }}
                    {% else %}
                    未知
                    {% endif %}
                  </small>
                  <small class="text-muted d-block">
                    {{ item.created_at.strftime('%Y-%m-%d') }}
                  </small>
                </div>
              </div>
              <a href="{{ item.url }}" target="_blank" class="btn btn-primary btn-sm">
                前往
                <i class="fas fa-external-link-alt"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
  {% endfor %}
  {% else %}
  <div class="alert alert-info">
    <i class="fas fa-info-circle"></i>
    暂无导航分类
  </div>
  {% endif %}
</div>

<!-- 卡片管理模态框 -->
<div class="modal fade" id="manageCardsModal" tabindex="-1" aria-labelledby="manageCardsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="manageCardsModalLabel">卡片管理</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>在这里管理您隐藏的导航卡片。</p>
        <ul class="list-group" id="hidden-cards-list">
          <!-- 隐藏的卡片将通过JS动态加载 -->
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          关闭
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/navigation.js') }}"></script>
{% endblock %}